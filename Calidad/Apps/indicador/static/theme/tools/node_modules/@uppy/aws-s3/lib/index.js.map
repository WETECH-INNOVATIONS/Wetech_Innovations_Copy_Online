{"version":3,"sources":["index.js"],"names":["URL_","URL","require","Plugin","RateLimitedQueue","settle","hasProperty","RequestClient","qsStringify","MiniXHRUpload","isXml","resolveUrl","origin","link","toString","getXmlValue","source","tagName","start","indexOf","end","slice","length","assertServerError","res","error","Error","message","warnedSuccessActionStatus","module","exports","uppy","opts","type","id","title","defaultOptions","timeout","limit","metaFields","getUploadParameters","bind","client","handleUpload","requests","file","companionUrl","filename","meta","name","metadata","forEach","key","query","get","then","validateParameters","params","valid","url","fields","method","test","err","TypeError","console","fileIDs","paramsPromises","Object","create","onremove","abort","on","getFile","emit","wrapPromiseFunction","numberOfFiles","map","index","headers","xhrOpts","formData","toLowerCase","endpoint","keys","setFileState","xhrUpload","_uploader","uploadFile","catch","settled","off","install","addUploader","defaultGetResponseData","content","xhr","toUpperCase","log","location","responseURL","replace","bucket","etag","defaultGetResponseError","xhrOptions","fieldName","responseUrlFieldName","__queue","responseType","getResponseData","getResponseError","i18n","uninstall","removePreProcessor","VERSION"],"mappings":"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","sourcesContent":["/**\n * This plugin is currently a A Big Hackâ„¢! The core reason for that is how this plugin\n * interacts with Uppy's current pipeline design. The pipeline can handle files in steps,\n * including preprocessing, uploading, and postprocessing steps. This plugin initially\n * was designed to do its work in a preprocessing step, and let XHRUpload deal with the\n * actual file upload as an uploading step. However, Uppy runs steps on all files at once,\n * sequentially: first, all files go through a preprocessing step, then, once they are all\n * done, they go through the uploading step.\n *\n * For S3, this causes severely broken behaviour when users upload many files. The\n * preprocessing step will request S3 upload URLs that are valid for a short time only,\n * but it has to do this for _all_ files, which can take a long time if there are hundreds\n * or even thousands of files. By the time the uploader step starts, the first URLs may\n * already have expired. If not, the uploading might take such a long time that later URLs\n * will expire before some files can be uploaded.\n *\n * The long-term solution to this problem is to change the upload pipeline so that files\n * can be sent to the next step individually. That requires a breakig change, so it is\n * planned for Uppy v2.\n *\n * In the mean time, this plugin is stuck with a hackier approach: the necessary parts\n * of the XHRUpload implementation were copied into this plugin, as the MiniXHRUpload\n * class, and this plugin calls into it immediately once it receives an upload URL.\n * This isn't as nicely modular as we'd like and requires us to maintain two copies of\n * the XHRUpload code, but at least it's not horrifically broken :)\n */\n\n// If global `URL` constructor is available, use it\nconst URL_ = typeof URL === 'function' ? URL : require('url-parse')\nconst { Plugin } = require('@uppy/core')\nconst RateLimitedQueue = require('@uppy/utils/lib/RateLimitedQueue')\nconst settle = require('@uppy/utils/lib/settle')\nconst hasProperty = require('@uppy/utils/lib/hasProperty')\nconst { RequestClient } = require('@uppy/companion-client')\nconst qsStringify = require('qs-stringify')\nconst MiniXHRUpload = require('./MiniXHRUpload')\nconst isXml = require('./isXml')\n\nfunction resolveUrl (origin, link) {\n  return origin\n    ? new URL_(link, origin).toString()\n    : new URL_(link).toString()\n}\n\n/**\n * Get the contents of a named tag in an XML source string.\n *\n * @param {string} source - The XML source string.\n * @param {string} tagName - The name of the tag.\n * @returns {string} The contents of the tag, or the empty string if the tag does not exist.\n */\nfunction getXmlValue (source, tagName) {\n  const start = source.indexOf(`<${tagName}>`)\n  const end = source.indexOf(`</${tagName}>`, start)\n  return start !== -1 && end !== -1\n    ? source.slice(start + tagName.length + 2, end)\n    : ''\n}\n\nfunction assertServerError (res) {\n  if (res && res.error) {\n    const error = new Error(res.message)\n    Object.assign(error, res.error)\n    throw error\n  }\n  return res\n}\n\n// warning deduplication flag: see `getResponseData()` XHRUpload option definition\nlet warnedSuccessActionStatus = false\n\nmodule.exports = class AwsS3 extends Plugin {\n  static VERSION = require('../package.json').version\n\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.type = 'uploader'\n    this.id = this.opts.id || 'AwsS3'\n    this.title = 'AWS S3'\n\n    const defaultOptions = {\n      timeout: 30 * 1000,\n      limit: 0,\n      metaFields: [], // have to opt in\n      getUploadParameters: this.getUploadParameters.bind(this)\n    }\n\n    this.opts = { ...defaultOptions, ...opts }\n\n    this.client = new RequestClient(uppy, opts)\n    this.handleUpload = this.handleUpload.bind(this)\n    this.requests = new RateLimitedQueue(this.opts.limit)\n  }\n\n  getUploadParameters (file) {\n    if (!this.opts.companionUrl) {\n      throw new Error('Expected a `companionUrl` option containing a Companion address.')\n    }\n\n    const filename = file.meta.name\n    const type = file.meta.type\n    const metadata = {}\n    this.opts.metaFields.forEach((key) => {\n      if (file.meta[key] != null) {\n        metadata[key] = file.meta[key].toString()\n      }\n    })\n\n    const query = qsStringify({ filename, type, metadata })\n    return this.client.get(`s3/params?${query}`)\n      .then(assertServerError)\n  }\n\n  validateParameters (file, params) {\n    const valid = typeof params === 'object' && params &&\n      typeof params.url === 'string' &&\n      (typeof params.fields === 'object' || params.fields == null) &&\n      (params.method == null || /^(put|post)$/i.test(params.method))\n\n    if (!valid) {\n      const err = new TypeError(`AwsS3: got incorrect result from 'getUploadParameters()' for file '${file.name}', expected an object '{ url, method, fields, headers }'.\\nSee https://uppy.io/docs/aws-s3/#getUploadParameters-file for more on the expected format.`)\n      console.error(err)\n      throw err\n    }\n  }\n\n  handleUpload (fileIDs) {\n    /**\n     * keep track of `getUploadParameters()` responses\n     * so we can cancel the calls individually using just a file ID\n     *\n     * @type {object.<string, Promise>}\n     */\n    const paramsPromises = Object.create(null)\n\n    function onremove (file) {\n      const { id } = file\n      if (hasProperty(paramsPromises, id)) {\n        paramsPromises[id].abort()\n      }\n    }\n    this.uppy.on('file-removed', onremove)\n\n    fileIDs.forEach((id) => {\n      const file = this.uppy.getFile(id)\n      this.uppy.emit('upload-started', file)\n    })\n\n    const getUploadParameters = this.requests.wrapPromiseFunction((file) => {\n      return this.opts.getUploadParameters(file)\n    })\n\n    const numberOfFiles = fileIDs.length\n\n    return settle(fileIDs.map((id, index) => {\n      paramsPromises[id] = getUploadParameters(this.uppy.getFile(id))\n      return paramsPromises[id].then((params) => {\n        delete paramsPromises[id]\n\n        const file = this.uppy.getFile(id)\n        this.validateParameters(file, params)\n\n        const {\n          method = 'post',\n          url,\n          fields,\n          headers\n        } = params\n        const xhrOpts = {\n          method,\n          formData: method.toLowerCase() === 'post',\n          endpoint: url,\n          metaFields: fields ? Object.keys(fields) : []\n        }\n\n        if (headers) {\n          xhrOpts.headers = headers\n        }\n\n        this.uppy.setFileState(file.id, {\n          meta: { ...file.meta, ...fields },\n          xhrUpload: xhrOpts\n        })\n\n        return this._uploader.uploadFile(file.id, index, numberOfFiles)\n      }).catch((error) => {\n        delete paramsPromises[id]\n\n        const file = this.uppy.getFile(id)\n        this.uppy.emit('upload-error', file, error)\n      })\n    })).then((settled) => {\n      // cleanup.\n      this.uppy.off('file-removed', onremove)\n      return settled\n    })\n  }\n\n  install () {\n    const uppy = this.uppy\n    this.uppy.addUploader(this.handleUpload)\n\n    // Get the response data from a successful XMLHttpRequest instance.\n    // `content` is the S3 response as a string.\n    // `xhr` is the XMLHttpRequest instance.\n    function defaultGetResponseData (content, xhr) {\n      const opts = this\n\n      // If no response, we've hopefully done a PUT request to the file\n      // in the bucket on its full URL.\n      if (!isXml(content, xhr)) {\n        if (opts.method.toUpperCase() === 'POST') {\n          if (!warnedSuccessActionStatus) {\n            uppy.log('[AwsS3] No response data found, make sure to set the success_action_status AWS SDK option to 201. See https://uppy.io/docs/aws-s3/#POST-Uploads', 'warning')\n            warnedSuccessActionStatus = true\n          }\n          // The responseURL won't contain the object key. Give up.\n          return { location: null }\n        }\n\n        // responseURL is not available in older browsers.\n        if (!xhr.responseURL) {\n          return { location: null }\n        }\n\n        // Trim the query string because it's going to be a bunch of presign\n        // parameters for a PUT requestâ€”doing a GET request with those will\n        // always result in an error\n        return { location: xhr.responseURL.replace(/\\?.*$/, '') }\n      }\n\n      return {\n        // Some S3 alternatives do not reply with an absolute URL.\n        // Eg DigitalOcean Spaces uses /$bucketName/xyz\n        location: resolveUrl(xhr.responseURL, getXmlValue(content, 'Location')),\n        bucket: getXmlValue(content, 'Bucket'),\n        key: getXmlValue(content, 'Key'),\n        etag: getXmlValue(content, 'ETag')\n      }\n    }\n\n    // Get the error data from a failed XMLHttpRequest instance.\n    // `content` is the S3 response as a string.\n    // `xhr` is the XMLHttpRequest instance.\n    function defaultGetResponseError (content, xhr) {\n      // If no response, we don't have a specific error message, use the default.\n      if (!isXml(content, xhr)) {\n        return\n      }\n      const error = getXmlValue(content, 'Message')\n      return new Error(error)\n    }\n\n    const xhrOptions = {\n      fieldName: 'file',\n      responseUrlFieldName: 'location',\n      timeout: this.opts.timeout,\n      // Share the rate limiting queue with XHRUpload.\n      __queue: this.requests,\n      responseType: 'text',\n      getResponseData: this.opts.getResponseData || defaultGetResponseData,\n      getResponseError: defaultGetResponseError\n    }\n\n    // Revert to `this.uppy.use(XHRUpload)` once the big comment block at the top of\n    // this file is solved\n    this._uploader = new MiniXHRUpload(this.uppy, xhrOptions)\n    this._uploader.i18n = this.uppy.i18n\n  }\n\n  uninstall () {\n    this.uppy.removePreProcessor(this.handleUpload)\n  }\n}\n"]}