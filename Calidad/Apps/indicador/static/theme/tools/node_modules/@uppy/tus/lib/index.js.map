{"version":3,"sources":["index.js"],"names":["require","Plugin","tus","Provider","RequestClient","Socket","emitSocketProgress","getSocketHost","settle","EventTracker","NetworkError","isNetworkError","RateLimitedQueue","hasProperty","getFingerprint","tusDefaultOptions","endpoint","uploadUrl","metadata","uploadSize","onProgress","onChunkComplete","onSuccess","onError","overridePatchMethod","headers","addRequestId","chunkSize","Infinity","retryDelays","parallelUploads","storeFingerprintForResuming","removeFingerprintOnSuccess","uploadLengthDeferred","uploadDataDuringCreation","module","exports","uppy","opts","type","id","title","defaultOptions","autoRetry","resume","useFastRemoteRetry","limit","requests","uploaders","Object","create","uploaderEvents","uploaderSockets","handleResetProgress","bind","handleUpload","files","getState","keys","forEach","fileID","tusState","setState","resetUploaderReferences","uploader","abort","setTimeout","remove","close","upload","file","current","total","Promise","resolve","reject","emit","uploadOptions","fingerprint","err","log","xhr","originalRequest","getUnderlyingObject","queuedRequest","done","bytesUploaded","bytesTotal","onReceiveUploadUrl","url","uploadResp","uploadURL","name","copyProp","obj","srcProp","destProp","meta","metaFields","Array","isArray","item","Upload","data","findPreviousUploads","then","previousUploads","previousUpload","creationTime","resumeFromPreviousUpload","run","isPaused","start","onFileRemove","targetFileID","onPause","onPauseAll","onCancelAll","onResumeAll","error","catch","uploadRemote","remote","serverToken","connectToServerSocket","Client","providerOptions","provider","client","post","body","protocol","size","res","setFileState","token","getFile","host","companionUrl","socket","target","autoOpen","send","onRetry","isOpen","onRetryAll","on","progressData","errData","message","Error","cause","open","currentFile","cb","filesToRetry","uploadFiles","promises","map","i","length","isRemote","fileIDs","filesToUpload","install","capabilities","resumableUploads","addUploader","retryAll","uninstall","removeUploader","off","VERSION"],"mappings":"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","sourcesContent":["const { Plugin } = require('@uppy/core')\nconst tus = require('tus-js-client')\nconst { Provider, RequestClient, Socket } = require('@uppy/companion-client')\nconst emitSocketProgress = require('@uppy/utils/lib/emitSocketProgress')\nconst getSocketHost = require('@uppy/utils/lib/getSocketHost')\nconst settle = require('@uppy/utils/lib/settle')\nconst EventTracker = require('@uppy/utils/lib/EventTracker')\nconst NetworkError = require('@uppy/utils/lib/NetworkError')\nconst isNetworkError = require('@uppy/utils/lib/isNetworkError')\nconst RateLimitedQueue = require('@uppy/utils/lib/RateLimitedQueue')\nconst hasProperty = require('@uppy/utils/lib/hasProperty')\nconst getFingerprint = require('./getFingerprint')\n\n/** @typedef {import('..').TusOptions} TusOptions */\n/** @typedef {import('tus-js-client').UploadOptions} RawTusOptions */\n/** @typedef {import('@uppy/core').Uppy} Uppy */\n/** @typedef {import('@uppy/core').UppyFile} UppyFile */\n/** @typedef {import('@uppy/core').FailedUppyFile<{}>} FailedUppyFile */\n\n/**\n * Extracted from https://github.com/tus/tus-js-client/blob/master/lib/upload.js#L13\n * excepted we removed 'fingerprint' key to avoid adding more dependencies\n *\n * @type {RawTusOptions}\n */\nconst tusDefaultOptions = {\n  endpoint: '',\n\n  uploadUrl: null,\n  metadata: {},\n  uploadSize: null,\n\n  onProgress: null,\n  onChunkComplete: null,\n  onSuccess: null,\n  onError: null,\n\n  overridePatchMethod: false,\n  headers: {},\n  addRequestId: false,\n\n  chunkSize: Infinity,\n  retryDelays: [0, 1000, 3000, 5000],\n  parallelUploads: 1,\n  storeFingerprintForResuming: true,\n  removeFingerprintOnSuccess: false,\n  uploadLengthDeferred: false,\n  uploadDataDuringCreation: false\n}\n\n/**\n * Tus resumable file uploader\n */\nmodule.exports = class Tus extends Plugin {\n  static VERSION = require('../package.json').version\n\n  /**\n   * @param {Uppy} uppy\n   * @param {TusOptions} opts\n   */\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.type = 'uploader'\n    this.id = this.opts.id || 'Tus'\n    this.title = 'Tus'\n\n    // set default options\n    const defaultOptions = {\n      autoRetry: true,\n      resume: true,\n      useFastRemoteRetry: true,\n      limit: 0,\n      retryDelays: [0, 1000, 3000, 5000]\n    }\n\n    // merge default options with the ones set by user\n    /** @type {import(\"..\").TusOptions} */\n    this.opts = Object.assign({}, defaultOptions, opts)\n\n    /**\n     * Simultaneous upload limiting is shared across all uploads with this plugin.\n     *\n     * @type {RateLimitedQueue}\n     */\n    this.requests = new RateLimitedQueue(this.opts.limit)\n\n    this.uploaders = Object.create(null)\n    this.uploaderEvents = Object.create(null)\n    this.uploaderSockets = Object.create(null)\n\n    this.handleResetProgress = this.handleResetProgress.bind(this)\n    this.handleUpload = this.handleUpload.bind(this)\n  }\n\n  handleResetProgress () {\n    const files = Object.assign({}, this.uppy.getState().files)\n    Object.keys(files).forEach((fileID) => {\n      // Only clone the file object if it has a Tus `uploadUrl` attached.\n      if (files[fileID].tus && files[fileID].tus.uploadUrl) {\n        const tusState = Object.assign({}, files[fileID].tus)\n        delete tusState.uploadUrl\n        files[fileID] = Object.assign({}, files[fileID], { tus: tusState })\n      }\n    })\n\n    this.uppy.setState({ files })\n  }\n\n  /**\n   * Clean up all references for a file's upload: the tus.Upload instance,\n   * any events related to the file, and the Companion WebSocket connection.\n   *\n   * @param {string} fileID\n   */\n  resetUploaderReferences (fileID, opts = {}) {\n    if (this.uploaders[fileID]) {\n      const uploader = this.uploaders[fileID]\n      uploader.abort()\n      if (opts.abort) {\n        // to avoid 423 error from tus server, we wait\n        // to be sure the previous request has been aborted before terminating the upload\n        // @todo remove the timeout when this \"wait\" is handled in tus-js-client internally\n        setTimeout(() => uploader.abort(true), 1000)\n      }\n      this.uploaders[fileID] = null\n    }\n    if (this.uploaderEvents[fileID]) {\n      this.uploaderEvents[fileID].remove()\n      this.uploaderEvents[fileID] = null\n    }\n    if (this.uploaderSockets[fileID]) {\n      this.uploaderSockets[fileID].close()\n      this.uploaderSockets[fileID] = null\n    }\n  }\n\n  /**\n   * Create a new Tus upload.\n   *\n   * A lot can happen during an upload, so this is quite hard to follow!\n   * - First, the upload is started. If the file was already paused by the time the upload starts, nothing should happen.\n   *   If the `limit` option is used, the upload must be queued onto the `this.requests` queue.\n   *   When an upload starts, we store the tus.Upload instance, and an EventTracker instance that manages the event listeners\n   *   for pausing, cancellation, removal, etc.\n   * - While the upload is in progress, it may be paused or cancelled.\n   *   Pausing aborts the underlying tus.Upload, and removes the upload from the `this.requests` queue. All other state is\n   *   maintained.\n   *   Cancelling removes the upload from the `this.requests` queue, and completely aborts the upload--the tus.Upload instance\n   *   is aborted and discarded, the EventTracker instance is destroyed (removing all listeners).\n   *   Resuming the upload uses the `this.requests` queue as well, to prevent selectively pausing and resuming uploads from\n   *   bypassing the limit.\n   * - After completing an upload, the tus.Upload and EventTracker instances are cleaned up, and the upload is marked as done\n   *   in the `this.requests` queue.\n   * - When an upload completed with an error, the same happens as on successful completion, but the `upload()` promise is rejected.\n   *\n   * When working on this function, keep in mind:\n   *  - When an upload is completed or cancelled for any reason, the tus.Upload and EventTracker instances need to be cleaned up using this.resetUploaderReferences().\n   *  - When an upload is cancelled or paused, for any reason, it needs to be removed from the `this.requests` queue using `queuedRequest.abort()`.\n   *  - When an upload is completed for any reason, including errors, it needs to be marked as such using `queuedRequest.done()`.\n   *  - When an upload is started or resumed, it needs to go through the `this.requests` queue. The `queuedRequest` variable must be updated so the other uses of it are valid.\n   *  - Before replacing the `queuedRequest` variable, the previous `queuedRequest` must be aborted, else it will keep taking up a spot in the queue.\n   *\n   * @param {UppyFile} file for use with upload\n   * @param {number} current file in a queue\n   * @param {number} total number of files in a queue\n   * @returns {Promise<void>}\n   */\n  upload (file, current, total) {\n    this.resetUploaderReferences(file.id)\n\n    // Create a new tus upload\n    return new Promise((resolve, reject) => {\n      this.uppy.emit('upload-started', file)\n\n      const opts = {\n        ...this.opts,\n        ...(file.tus || {})\n      }\n\n      /** @type {RawTusOptions} */\n      const uploadOptions = {\n        ...tusDefaultOptions,\n        // TODO only put tus-specific options in?\n        ...opts\n      }\n\n      delete uploadOptions.resume\n\n      // Make `resume: true` work like it did in tus-js-client v1.\n      // TODO: Remove in @uppy/tus v2\n      if (opts.resume) {\n        uploadOptions.storeFingerprintForResuming = true\n      }\n\n      // We override tus fingerprint to uppy’s `file.id`, since the `file.id`\n      // now also includes `relativePath` for files added from folders.\n      // This means you can add 2 identical files, if one is in folder a,\n      // the other in folder b.\n      uploadOptions.fingerprint = getFingerprint(file)\n\n      uploadOptions.onError = (err) => {\n        this.uppy.log(err)\n\n        const xhr = err.originalRequest ? err.originalRequest.getUnderlyingObject() : null\n        if (isNetworkError(xhr)) {\n          err = new NetworkError(err, xhr)\n        }\n\n        this.resetUploaderReferences(file.id)\n        queuedRequest.done()\n\n        this.uppy.emit('upload-error', file, err)\n\n        reject(err)\n      }\n\n      uploadOptions.onProgress = (bytesUploaded, bytesTotal) => {\n        this.onReceiveUploadUrl(file, upload.url)\n        this.uppy.emit('upload-progress', file, {\n          uploader: this,\n          bytesUploaded: bytesUploaded,\n          bytesTotal: bytesTotal\n        })\n      }\n\n      uploadOptions.onSuccess = () => {\n        const uploadResp = {\n          uploadURL: upload.url\n        }\n\n        this.resetUploaderReferences(file.id)\n        queuedRequest.done()\n\n        this.uppy.emit('upload-success', file, uploadResp)\n\n        if (upload.url) {\n          this.uppy.log('Download ' + upload.file.name + ' from ' + upload.url)\n        }\n\n        resolve(upload)\n      }\n\n      const copyProp = (obj, srcProp, destProp) => {\n        if (hasProperty(obj, srcProp) && !hasProperty(obj, destProp)) {\n          obj[destProp] = obj[srcProp]\n        }\n      }\n\n      /** @type {{ [name: string]: string }} */\n      const meta = {}\n      const metaFields = Array.isArray(opts.metaFields)\n        ? opts.metaFields\n        // Send along all fields by default.\n        : Object.keys(file.meta)\n      metaFields.forEach((item) => {\n        meta[item] = file.meta[item]\n      })\n\n      // tusd uses metadata fields 'filetype' and 'filename'\n      copyProp(meta, 'type', 'filetype')\n      copyProp(meta, 'name', 'filename')\n\n      uploadOptions.metadata = meta\n\n      const upload = new tus.Upload(file.data, uploadOptions)\n      this.uploaders[file.id] = upload\n      this.uploaderEvents[file.id] = new EventTracker(this.uppy)\n\n      // Make `resume: true` work like it did in tus-js-client v1.\n      // TODO: Remove in @uppy/tus v2.\n      if (opts.resume) {\n        upload.findPreviousUploads().then((previousUploads) => {\n          const previousUpload = previousUploads[0]\n          if (previousUpload) {\n            this.uppy.log(`[Tus] Resuming upload of ${file.id} started at ${previousUpload.creationTime}`)\n            upload.resumeFromPreviousUpload(previousUpload)\n          }\n        })\n      }\n\n      let queuedRequest = this.requests.run(() => {\n        if (!file.isPaused) {\n          // Ensure this gets scheduled to run _after_ `findPreviousUploads()` returns.\n          // TODO: Remove in @uppy/tus v2.\n          Promise.resolve().then(() => {\n            upload.start()\n          })\n        }\n        // Don't do anything here, the caller will take care of cancelling the upload itself\n        // using resetUploaderReferences(). This is because resetUploaderReferences() has to be\n        // called when this request is still in the queue, and has not been started yet, too. At\n        // that point this cancellation function is not going to be called.\n        // Also, we need to remove the request from the queue _without_ destroying everything\n        // related to this upload to handle pauses.\n        return () => {}\n      })\n\n      this.onFileRemove(file.id, (targetFileID) => {\n        queuedRequest.abort()\n        this.resetUploaderReferences(file.id, { abort: !!upload.url })\n        resolve(`upload ${targetFileID} was removed`)\n      })\n\n      this.onPause(file.id, (isPaused) => {\n        if (isPaused) {\n          // Remove this file from the queue so another file can start in its place.\n          queuedRequest.abort()\n          upload.abort()\n        } else {\n          // Resuming an upload should be queued, else you could pause and then resume a queued upload to make it skip the queue.\n          queuedRequest.abort()\n          queuedRequest = this.requests.run(() => {\n            upload.start()\n            return () => {}\n          })\n        }\n      })\n\n      this.onPauseAll(file.id, () => {\n        queuedRequest.abort()\n        upload.abort()\n      })\n\n      this.onCancelAll(file.id, () => {\n        queuedRequest.abort()\n        this.resetUploaderReferences(file.id, { abort: !!upload.url })\n        resolve(`upload ${file.id} was canceled`)\n      })\n\n      this.onResumeAll(file.id, () => {\n        queuedRequest.abort()\n        if (file.error) {\n          upload.abort()\n        }\n        queuedRequest = this.requests.run(() => {\n          upload.start()\n          return () => {}\n        })\n      })\n    }).catch((err) => {\n      this.uppy.emit('upload-error', file, err)\n      throw err\n    })\n  }\n\n  /**\n   * @param {UppyFile} file for use with upload\n   * @param {number} current file in a queue\n   * @param {number} total number of files in a queue\n   * @returns {Promise<void>}\n   */\n  uploadRemote (file, current, total) {\n    this.resetUploaderReferences(file.id)\n\n    const opts = { ...this.opts }\n    if (file.tus) {\n      // Install file-specific upload overrides.\n      Object.assign(opts, file.tus)\n    }\n\n    this.uppy.emit('upload-started', file)\n    this.uppy.log(file.remote.url)\n\n    if (file.serverToken) {\n      return this.connectToServerSocket(file)\n    }\n\n    return new Promise((resolve, reject) => {\n      const Client = file.remote.providerOptions.provider ? Provider : RequestClient\n      const client = new Client(this.uppy, file.remote.providerOptions)\n\n      // !! cancellation is NOT supported at this stage yet\n      client.post(file.remote.url, {\n        ...file.remote.body,\n        endpoint: opts.endpoint,\n        uploadUrl: opts.uploadUrl,\n        protocol: 'tus',\n        size: file.data.size,\n        headers: opts.headers,\n        metadata: file.meta\n      }).then((res) => {\n        this.uppy.setFileState(file.id, { serverToken: res.token })\n        file = this.uppy.getFile(file.id)\n        return this.connectToServerSocket(file)\n      }).then(() => {\n        resolve()\n      }).catch((err) => {\n        this.uppy.emit('upload-error', file, err)\n        reject(err)\n      })\n    })\n  }\n\n  /**\n   * See the comment on the upload() method.\n   *\n   * Additionally, when an upload is removed, completed, or cancelled, we need to close the WebSocket connection. This is handled by the resetUploaderReferences() function, so the same guidelines apply as in upload().\n   *\n   * @param {UppyFile} file\n   */\n  connectToServerSocket (file) {\n    return new Promise((resolve, reject) => {\n      const token = file.serverToken\n      const host = getSocketHost(file.remote.companionUrl)\n      const socket = new Socket({ target: `${host}/api/${token}`, autoOpen: false })\n      this.uploaderSockets[file.id] = socket\n      this.uploaderEvents[file.id] = new EventTracker(this.uppy)\n\n      this.onFileRemove(file.id, () => {\n        queuedRequest.abort()\n        // still send pause event in case we are dealing with older version of companion\n        // @todo don't send pause event in the next major release.\n        socket.send('pause', {})\n        socket.send('cancel', {})\n        this.resetUploaderReferences(file.id)\n        resolve(`upload ${file.id} was removed`)\n      })\n\n      this.onPause(file.id, (isPaused) => {\n        if (isPaused) {\n          // Remove this file from the queue so another file can start in its place.\n          queuedRequest.abort()\n          socket.send('pause', {})\n        } else {\n          // Resuming an upload should be queued, else you could pause and then resume a queued upload to make it skip the queue.\n          queuedRequest.abort()\n          queuedRequest = this.requests.run(() => {\n            socket.send('resume', {})\n            return () => {}\n          })\n        }\n      })\n\n      this.onPauseAll(file.id, () => {\n        queuedRequest.abort()\n        socket.send('pause', {})\n      })\n\n      this.onCancelAll(file.id, () => {\n        queuedRequest.abort()\n        // still send pause event in case we are dealing with older version of companion\n        // @todo don't send pause event in the next major release.\n        socket.send('pause', {})\n        socket.send('cancel', {})\n        this.resetUploaderReferences(file.id)\n        resolve(`upload ${file.id} was canceled`)\n      })\n\n      this.onResumeAll(file.id, () => {\n        queuedRequest.abort()\n        if (file.error) {\n          socket.send('pause', {})\n        }\n        queuedRequest = this.requests.run(() => {\n          socket.send('resume', {})\n          return () => {}\n        })\n      })\n\n      this.onRetry(file.id, () => {\n        // Only do the retry if the upload is actually in progress;\n        // else we could try to send these messages when the upload is still queued.\n        // We may need a better check for this since the socket may also be closed\n        // for other reasons, like network failures.\n        if (socket.isOpen) {\n          socket.send('pause', {})\n          socket.send('resume', {})\n        }\n      })\n\n      this.onRetryAll(file.id, () => {\n        // See the comment in the onRetry() call\n        if (socket.isOpen) {\n          socket.send('pause', {})\n          socket.send('resume', {})\n        }\n      })\n\n      socket.on('progress', (progressData) => emitSocketProgress(this, progressData, file))\n\n      socket.on('error', (errData) => {\n        const { message } = errData.error\n        const error = Object.assign(new Error(message), { cause: errData.error })\n\n        // If the remote retry optimisation should not be used,\n        // close the socket—this will tell companion to clear state and delete the file.\n        if (!this.opts.useFastRemoteRetry) {\n          this.resetUploaderReferences(file.id)\n          // Remove the serverToken so that a new one will be created for the retry.\n          this.uppy.setFileState(file.id, {\n            serverToken: null\n          })\n        } else {\n          socket.close()\n        }\n\n        this.uppy.emit('upload-error', file, error)\n        queuedRequest.done()\n        reject(error)\n      })\n\n      socket.on('success', (data) => {\n        const uploadResp = {\n          uploadURL: data.url\n        }\n\n        this.uppy.emit('upload-success', file, uploadResp)\n        this.resetUploaderReferences(file.id)\n        queuedRequest.done()\n\n        resolve()\n      })\n\n      let queuedRequest = this.requests.run(() => {\n        socket.open()\n        if (file.isPaused) {\n          socket.send('pause', {})\n        }\n\n        // Don't do anything here, the caller will take care of cancelling the upload itself\n        // using resetUploaderReferences(). This is because resetUploaderReferences() has to be\n        // called when this request is still in the queue, and has not been started yet, too. At\n        // that point this cancellation function is not going to be called.\n        // Also, we need to remove the request from the queue _without_ destroying everything\n        // related to this upload to handle pauses.\n        return () => {}\n      })\n    })\n  }\n\n  /**\n   * Store the uploadUrl on the file options, so that when Golden Retriever\n   * restores state, we will continue uploading to the correct URL.\n   *\n   * @param {UppyFile} file\n   * @param {string} uploadURL\n   */\n  onReceiveUploadUrl (file, uploadURL) {\n    const currentFile = this.uppy.getFile(file.id)\n    if (!currentFile) return\n    // Only do the update if we didn't have an upload URL yet.\n    if (!currentFile.tus || currentFile.tus.uploadUrl !== uploadURL) {\n      this.uppy.log('[Tus] Storing upload url')\n      this.uppy.setFileState(currentFile.id, {\n        tus: Object.assign({}, currentFile.tus, {\n          uploadUrl: uploadURL\n        })\n      })\n    }\n  }\n\n  /**\n   * @param {string} fileID\n   * @param {function(string): void} cb\n   */\n  onFileRemove (fileID, cb) {\n    this.uploaderEvents[fileID].on('file-removed', (file) => {\n      if (fileID === file.id) cb(file.id)\n    })\n  }\n\n  /**\n   * @param {string} fileID\n   * @param {function(boolean): void} cb\n   */\n  onPause (fileID, cb) {\n    this.uploaderEvents[fileID].on('upload-pause', (targetFileID, isPaused) => {\n      if (fileID === targetFileID) {\n        // const isPaused = this.uppy.pauseResume(fileID)\n        cb(isPaused)\n      }\n    })\n  }\n\n  /**\n   * @param {string} fileID\n   * @param {function(): void} cb\n   */\n  onRetry (fileID, cb) {\n    this.uploaderEvents[fileID].on('upload-retry', (targetFileID) => {\n      if (fileID === targetFileID) {\n        cb()\n      }\n    })\n  }\n\n  /**\n   * @param {string} fileID\n   * @param {function(): void} cb\n   */\n  onRetryAll (fileID, cb) {\n    this.uploaderEvents[fileID].on('retry-all', (filesToRetry) => {\n      if (!this.uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  /**\n   * @param {string} fileID\n   * @param {function(): void} cb\n   */\n  onPauseAll (fileID, cb) {\n    this.uploaderEvents[fileID].on('pause-all', () => {\n      if (!this.uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  /**\n   * @param {string} fileID\n   * @param {function(): void} cb\n   */\n  onCancelAll (fileID, cb) {\n    this.uploaderEvents[fileID].on('cancel-all', () => {\n      if (!this.uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  /**\n   * @param {string} fileID\n   * @param {function(): void} cb\n   */\n  onResumeAll (fileID, cb) {\n    this.uploaderEvents[fileID].on('resume-all', () => {\n      if (!this.uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  /**\n   * @param {(UppyFile | FailedUppyFile)[]} files\n   */\n  uploadFiles (files) {\n    const promises = files.map((file, i) => {\n      const current = i + 1\n      const total = files.length\n\n      if ('error' in file && file.error) {\n        return Promise.reject(new Error(file.error))\n      } else if (file.isRemote) {\n        return this.uploadRemote(file, current, total)\n      } else {\n        return this.upload(file, current, total)\n      }\n    })\n\n    return settle(promises)\n  }\n\n  /**\n   * @param {string[]} fileIDs\n   */\n  handleUpload (fileIDs) {\n    if (fileIDs.length === 0) {\n      this.uppy.log('[Tus] No files to upload')\n      return Promise.resolve()\n    }\n\n    if (this.opts.limit === 0) {\n      this.uppy.log(\n        '[Tus] When uploading multiple files at once, consider setting the `limit` option (to `10` for example), to limit the number of concurrent uploads, which helps prevent memory and network issues: https://uppy.io/docs/tus/#limit-0',\n        'warning'\n      )\n    }\n\n    this.uppy.log('[Tus] Uploading...')\n    const filesToUpload = fileIDs.map((fileID) => this.uppy.getFile(fileID))\n\n    return this.uploadFiles(filesToUpload)\n      .then(() => null)\n  }\n\n  install () {\n    this.uppy.setState({\n      capabilities: Object.assign({}, this.uppy.getState().capabilities, {\n        resumableUploads: true\n      })\n    })\n    this.uppy.addUploader(this.handleUpload)\n\n    this.uppy.on('reset-progress', this.handleResetProgress)\n\n    if (this.opts.autoRetry) {\n      this.uppy.on('back-online', this.uppy.retryAll)\n    }\n  }\n\n  uninstall () {\n    this.uppy.setState({\n      capabilities: Object.assign({}, this.uppy.getState().capabilities, {\n        resumableUploads: false\n      })\n    })\n    this.uppy.removeUploader(this.handleUpload)\n\n    if (this.opts.autoRetry) {\n      this.uppy.off('back-online', this.uppy.retryAll)\n    }\n  }\n}\n"]}